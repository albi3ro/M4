<!DOCTYPE html>
<html>


  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Julia with MKL on OSX</title>
    <!-- <meta name="description" content="Blog Introduction to Computational Condensed Matter Physics"> -->
    <link rel="stylesheet" href="/M4/css/main.css">
    <link rel="canonical" href="http://localhost:4000/M4/programming/MKL.html">
    <meta name="google-site-verification" content="FLWeXTRDBUYGSJXcdiUyqbwExBElCj76l3EdhtLL-wI" />
          <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
      inlineMath: [ ['$','$'], ['\(', '\)'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true,
    }
  });
</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    <meta property="og:title" content="Julia with MKL on OSX" />
    <meta property="og:image" content="" />
    <meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="@PyrochloreLee" />
    <meta property="twitter:title" content="Julia with MKL on OSX" />
    <meta property="twitter:image" content="" />
    <meta property="twitter:description" content="" />

    <link rel="apple-touch-icon" sizes="180x180" href="/M4/Images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/M4/Images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/M4/Images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/M4/Images/favicons/manifest.json">
    <link rel="mask-icon" href="/M4/Images/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#000000">

</head>


  <body>


    <header class="site-header">

  <div>

    <a class="site-title" href="/M4/">Metals, Magnets, and Miscellaneous Materials</a>



  </div>

</header>




    <div class="page-content">
        <div class="downloadzp"><a href="https://github.com/albi3ro/M4/archive/master.zip" class="sidebar">Zip!</a></div>

        <div class="clonelink"><a href="https://github.com/albi3ro/M4.git" class="sidebar">Clone!</a></div>

        <div class="juliadocs"><a href="http://docs.julialang.org/en/latest/manual/" class="sidebar">Docs</a></div>

        <div class="juliahelp"><a href="/M4/jupyterjulia" class="sidebar">Interact</a></div>

        <div class="about"><a href="/M4/about" class="sidebar">About</a></div>

      <div class="wrapper">
        <div class="post">
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="author" content="Christina C. Lee" />

  <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  <header class="post-header">
    <h1 class="post-title" itemprop="name">Julia with MKL on OSX</h1>
    <p class="post-meta">Author: Christina C. Lee &nbsp;&nbsp;&nbsp;&nbsp;
      Category: <a href="/M4/categories">
        Programming</a> &nbsp;  &nbsp; &nbsp; &nbsp;
        Tags:
      
  </header>

  <article class="post-content">

    <h1 id="introduction">Introduction</h1>

<p>One of the great things about Julia for those in scientific computing is the ease of accessing highly optimized libraries.  For matrix operations, Julia comes inbuilt with OpenBLAS, an open source implementation of BLAS, the Basic Linear Algebra Subprograms.</p>

<p>For the majority of people, that’s wonderful. OpenBLAS is quite fast and optimized.</p>

<p>BUT, when you want to diagonalize the large matrices that I do, there’s something better, Intel’s Math Kernel Library, MKL.</p>

<p>As Intel designed the chips and the hardware drivers for just about everyone, they can design their implementation of BLAS to take advantage of the specifics of the hardware and get a speed boost.  More to my purposes, it also doesn’t start aborting on larger matrices, even though I had plenty of RAM left.  The downside: they get this boost from trade secrets, and thus the software is propriety and behind closed doors.  Moral objections for some, monetary objections for others.</p>

<p>If you want to get MKL for yourself, you have two possible routes:</p>

<ul>
  <li>
    <p>A free community license through <a href="https://software.intel.com/sites/campaigns/nest/">Intel Aviary</a> . I got this for my workstation.</p>
  </li>
  <li>
    <p>Convince your company/ university/ institute to get the fully supported and expensive version. For example, my institute’s cluster has all of Intel’s tools.</p>
  </li>
</ul>

<h1 id="do-you-need-this">Do you need this?</h1>

<p>Before you start trying to implement this on your system, take a second and decide whether or not it is worth your while.   What kind of systems are you trying to diagonalize? Are you going to be diagonalizing systems at all?  Or multiplying large matrices… that would count too…</p>

<p>I generated matrices through <code class="highlighter-rouge">A=randn(n,n);</code> and then diagonalized them through <code class="highlighter-rouge">@time eigfact(A);</code>.</p>

<p>All of these specs are for my Mac Pro, Late 2013 model, running OSX El Capitan.  Processor: 3.7 GHz Quad-Core Intel Xeon E5.  Memory: 64 GB 1866 MHz DDR3 ECC.  I would be interested in seeing data for other processors.</p>

<!-- _includes/image.html -->
<div class="image-wrapper">
    
        <img src="http://localhost:4000/M4/Images/MKL/timescaling.png" alt="Time Scaling" />
    
    
        <p class="image-caption">Time scaling for MKL and OpenBLAS.  Performed for a matrix with randomly generated values according to a normal distribution of unit standard deviation.</p>
    
</div>

<!-- _includes/image.html -->
<div class="image-wrapper">
    
        <img src="http://localhost:4000/M4/Images/MKL/factorscaling.png" alt="Factor Scaling" />
    
    
        <p class="image-caption">The ratio between OpenBLAS and MKL.  While comporable at small system sizes, at larger matrices, MKL shows a significant improvement.</p>
    
</div>

<!-- _includes/image.html -->
<div class="image-wrapper">
    
        <img src="http://localhost:4000/M4/Images/MKL/memoryscaling.png" alt="Memory Scaling" />
    
    
        <p class="image-caption">Both MKL and OpenBLAS showed the same memory usage for a given calculation.  The scaling appears quadratic, except for a deviation at small system sizes.</p>
    
</div>

<h1 id="what-you-need-to-do">What you need to do</h1>

<h3 id="for-intel">For Intel</h3>
<p>So in my <code class="highlighter-rouge">.zshrc</code>, or <code class="highlighter-rouge">.bashrc</code> for those who haven’t discovered the wonders of zsh, I now have</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export TBBROOT=fdsljkfds
source /opt/intel/mkl/bin/mklvars.sh intel64 ilp64
</code></pre>
</div>
<p>The value for <code class="highlighter-rouge">TBBROOT</code> is non-zero gobblety-gook.
Once you have added that, either restart your terminal, or type</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	source ~/.bashrc
</code></pre>
</div>
<p>to refresh your terminal.</p>

<p>Now, check that these environment variables are set up correctly:</p>

<ul>
  <li><code class="highlighter-rouge">MKLROOT</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/mkl</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">DYLD_LIBRARY_PATH</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/compiler/lib: /opt/intel//compilers_and_libraries_2016.2.146/mac/mkl/lib</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">LIBRARY_PATH</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/compiler/lib: /opt/intel//compilers_and_libraries_2016.2.146/mac/mkl/lib</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">NLSPATH</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/mkl/lib/locale/%l_%t/%N</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">MANPATH</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/man/en_US</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">CPATH</code>
    <ul>
      <li>/opt/intel//compilers_and_libraries_2016.2.146/mac/mkl/include</li>
    </ul>
  </li>
</ul>

<p>by typing</p>

<div class="highlighter-rouge"><pre class="highlight"><code>echo $NAME_OF_VARIABLE
</code></pre>
</div>
<p>Don’t just copy your variables against mine! Find your installation on the system, and checkout where the folders are.</p>

<h3 id="for-the-julia-installation">For the Julia Installation</h3>
<p>In the Julia file, edit <code class="highlighter-rouge">Make.inc</code> in this specific place</p>

<div class="highlighter-rouge"><pre class="highlight"><code>## Settings for various Intel tools
# Set to 1 to use MKL
USE_INTEL_MKL =1
# Set to 1 to use MKL FFT
USE_INTEL_MKL_FFT = 1
# Set to 1 to use Intel LIBM
USE_INTEL_LIBM ?= 0
# Set to 1 to enable profiling with Intel VTune Amplifier
USE_INTEL_JITEVENTS ?= 0
# Set to 1 to use Intel C, C++, and FORTRAN compilers
USEICC  ?= 0
USEIFC  ?= 0
</code></pre>
</div>
<p>Now in the Julia folder try</p>

<div class="highlighter-rouge"><pre class="highlight"><code>make
make install
</code></pre>
</div>

<h1 id="how-i-eventually-figured-this-out">How I eventually figured this out</h1>
<p>I was getting complaints when <code class="highlighter-rouge">make</code>ing Julia, that</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-L/opt/intel//compilers_and_libraries_2016.2.146/mac/tbb/lib
</code></pre>
</div>
<p>wasn’t found.  There was good reason it wasn’t found. It didn’t exist.  TBB stands for Threading Building Blocks, another one of Intel’s programs, but this one is meant for multicore C++ programs.  Sounds fairly useful, but off topic to what I need right now.</p>

<p>So I wanted to figure out why it was trying to link to that directory.  Looking in <code class="highlighter-rouge">/opt/intel/mkl/bin/mklvars.sh</code>, the program that sets environment variables for MKL, I discovered:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                if [ -z "${TBBROOT}" ]; then
                    mkl_ld_arch="${CPRO_PATH}/tbb/lib:${mkl_ld_arch}"
                fi
</code></pre>
</div>

<p>When the variable <code class="highlighter-rouge">TBBROOT</code> is zero, it adds this <code class="highlighter-rouge">tbb</code> folder to the path.   Since I can’t change that file, proprietary stuff, my work around is making <code class="highlighter-rouge">TBBROOT</code> non-zero.  Then <code class="highlighter-rouge">DYLD_LIBRARY_PATH</code>, which gets linked in the Julia <code class="highlighter-rouge">make</code> processes, only contains good locations.</p>

<p>Also, you can’t just run <code class="highlighter-rouge">source ...</code> to on the command line once and have the variables set for all eternity.  When I restarted my terminal the next day, the variables had cleared.  So I figured out the lines need to be put in the <code class="highlighter-rouge">~/.bashrc</code> (or <code class="highlighter-rouge">~/.zshrc</code>) instead of just run once.</p>

<h1 id="conculsions">Conculsions</h1>

<p>I still got warnings when making Julia, but obviously none that broke the installation.  Hopefully this work-around holds me over till this project is done, and hopefully it helps someone else too :)</p>

  </article>

</div>

      </div>
    </div>

    <div class="comment">
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'M4julia'; // required: replace example with your forum shortname
  var disqus_identifier = "/programming/MKL.html";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

    <footer class="site-footer">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>


  <div class="wrapper">

    <h2 class="footer-heading">Metals, Magnets, and Miscellaneous Materials</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Metals, Magnets, and Miscellaneous Materials</li>
          <li><a href="mailto:chrissie.c.l@gmail.com">chrissie.c.l@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/albi3ro">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">albi3ro</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/PyrochloreLee">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">PyrochloreLee</span>
            </a>
          </li>
          
          <li>
              <div class="fb-share-button"
               data-href="/M4/programming/MKL.html" data-layout="button_count"></div>

          </li>
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Blog Introduction to Computational Condensed Matter Physics</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-70984222-1', 'auto');
  ga('send', 'pageview');

</script>
